name: Daily Report (Parse)

on:
  schedule:
    - cron: "10 5 * * 1-5"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure build folders exist
        run: |
          set -euo pipefail
          mkdir -p build/text build/pdf data templates reporting config

      # 1) Hent PDF og lav TXT
      - name: PDF → text (FundConnect via ISIN)
        run: |
          set -euo pipefail
          python parser/pdf_to_text.py

      # (midlertidig) seed hvis tom
      - name: Seed text if empty (temporary)
        run: |
          set -euo pipefail
          mkdir -p build/text
          if [ -z "$(ls -A build/text 2>/dev/null)" ]; then
            echo "[SEED] build/text is empty → copying samples/text/*.txt"
            cp -v samples/text/*.txt build/text/ || true
          else
            echo "[SEED] build/text already has files"
          fi

      # 2) Fail fast hvis der ingen .txt er
      - name: Assert text files exist (fail fast if none)
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(build/text/*.txt)
          echo "Found ${#files[@]} .txt files in build/text"
          if [ ${#files[@]} -eq 0 ]; then
            echo "::error::No text files in build/text. PDF extraction likely failed or wrote to another folder."
            exit 1
          fi

      # 3) Kør din nuværende parser (må gerne give 0; vi falder tilbage nedenfor)
      - name: Parse PFA PDFs → latest.json (primary)
        run: |
          set -euo pipefail
          python -m parser.main || true

      # 4) Fallback-parser: Robust NAV + dato ud af TXT, selv ved skiftende layout
      - name: Fallback parse (from TXT → data/latest.json)
        if: ${{ !hashFiles('data/latest.json') }}
        run: |
          set -euo pipefail
          python - << 'PYCODE'
          import re, json, os, glob, pathlib
          from datetime import datetime

          TEXT_DIR = pathlib.Path("build/text")
          OUT_PATH = pathlib.Path("data/latest.json")
          OUT_PATH.parent.mkdir(parents=True, exist_ok=True)

          # Hjælpere
          def to_float_dk(s):
            # '1.234,56' -> 1234.56 ; '202,69' -> 202.69
            s = s.replace(".", "").replace(",", ".")
            try:
              return float(s)
            except Exception:
              return None

          # Fleksible mønstre
          re_date = re.compile(r"Indre\\s*v[æa]rdi\\s*dato\\s*([0-9]{2}-[0-9]{2}-[0-9]{4})", re.IGNORECASE)
          # Match tal i dansk format, men uden efterfølgende % (filtrér procenter fra afkast)
          re_number_no_pct = re.compile(r"([0-9]{1,3}(?:\\.[0-9]{3})*(?:,[0-9]+))(?!\\s*%)")
          re_valuta = re.compile(r"Valuta\\s+([A-Z]{3})", re.IGNORECASE)

          funds = []
          for txt_path in sorted(TEXT_DIR.glob("*.txt")):
            text = txt_path.read_text(encoding="utf-8", errors="ignore")
            low = text.lower()

            # Navn = første ikke-tomme linje
            name = None
            for line in text.splitlines():
              line = line.strip()
              if line:
                name = line
                break

            # Prøv direkte 'Indre værdi <tal>' (tillad støj imellem)
            nav = None
            m_nav_direct = re.search(
              r"Indre\\s*v[æa]rdi(?:\\s*[^0-9\\n]{0,60}\\s*)([0-9]{1,3}(?:\\.[0-9]{3})*(?:,[0-9]+)?)",
              text, re.IGNORECASE
            )
            if m_nav_direct:
              nav = to_float_dk(m_nav_direct.group(1))

            # Dato
            nav_date = None
            m_date = re_date.search(text)
            if m_date:
              raw = m_date.group(1)
              try:
                nav_date = datetime.strptime(raw, "%d-%m-%Y").date().isoformat()
              except Exception:
                nav_date = raw

            # Hvis nav stadig None: kig i STAMDATA-blokken
            if nav is None:
              # afgræns "Stamdata" → ("Afkast" eller "Afkast ved en opsparing")
              start = low.find("stamdata")
              if start != -1:
                # find nærmeste afslutning
                ends = [i for i in [low.find("afkast ved en opsparing", start), low.find("afkast", start)] if i != -1]
                end = min(ends) if ends else None
                block = text[start:end] if end else text[start:]
                # find alle tal uden %
                cands = [(m.group(1), m.start()) for m in re_number_no_pct.finditer(block)]
                if cands:
                  # hvis 'Indre værdi' findes i blokken, vælg tal tættest på den
                  idx_iv = block.lower().find("indre værdi")
                  if idx_iv != -1:
                    cands.sort(key=lambda t: abs(t[1] - idx_iv))
                    nav = to_float_dk(cands[0][0])
                  else:
                    # ellers vælg første "fornuftige" kandidat
                    nav = to_float_dk(cands[0][0])

            # Valuta (valgfrit)
            currency = None
            m_cur = re_valuta.search(text)
            if m_cur:
              currency = m_cur.group(1).upper()

            funds.append({
              "pfa_code": txt_path.stem,  # fx PFA000002703
              "name": name,
              "currency": currency,
              "nav": nav,
              "nav_date": nav_date
            })

          OUT_PATH.write_text(json.dumps({"funds": funds}, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"Wrote {OUT_PATH} with {len(funds)} entries")
          PYCODE

      # 5) Bekræft at latest.json findes og har indhold
      - name: Assert latest.json exists and not empty
        run: |
          set -euo pipefail
          test -s data/latest.json || (echo "::error::data/latest.json missing or empty" && exit 1)
          echo "== data/latest.json (first 120 lines) =="
          head -n 120 data/latest.json || true

      # 6) Udvidet diagnostik
      - name: Enhanced diagnostics (tree + sample content)
        run: |
          set -euo pipefail
          echo "== build/pdf =="; ls -la build/pdf || true
          echo "== build/text (should contain .txt) =="; ls -la build/text || true
          echo "== First TXT preview =="
          first_txt="$(ls build/text/*.txt 2>/dev/null | head -n1 || true)"
          echo "FIRST_TXT: $first_txt"
          if [ -n "${first_txt:-}" ] && [ -f "$first_txt" ]; then
            head -n 40 "$first_txt" || true
          fi
          echo "== data/latest.json (first 120 lines) =="
          head -n 120 data/latest.json || true

      # 7) Byg HTML
      - name: Build daily HTML
        run: |
          set -euo pipefail
          python reporting/build_daily.py

      # 8) Upload artifacts
      - name: Upload daily artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily
          path: build/daily.html
          if-no-files-found: error

      - name: Upload parse-debug (text + pdf)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parse-debug
          path: |
            build/text/
            build/pdf/
          if-no-files-found: ignore

      - name: Upload data artifact (latest.json)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-latest-json
          path: data/latest.json
          if-no-files-found: warn

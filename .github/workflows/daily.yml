name: Daily Report (Parse)

on:
  schedule:
    - cron: "10 5 * * 1-5"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Ensure build folders exist
        run: |
          set -euo pipefail
          mkdir -p build/text build/pdf data templates reporting config

      # 1) Hent PFA-PDF'er og konverter til TXT
      - name: PDF → text (FundConnect via ISIN)
        run: |
          set -euo pipefail
          python parser/pdf_to_text.py

      # (midlertidig) seed hvis tom
      - name: Seed text if empty (temporary)
        run: |
          set -euo pipefail
          mkdir -p build/text
          if [ -z "$(ls -A build/text 2>/dev/null)" ]; then
            echo "[SEED] build/text is empty → copying samples/text/*.txt"
            cp -v samples/text/*.txt build/text/ || true
          else
            echo "[SEED] build/text already has files"
          fi

      # 2) Fail fast hvis der ingen .txt er
      - name: Assert text files exist (fail fast if none)
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(build/text/*.txt)
          echo "Found ${#files[@]} .txt files in build/text"
          if [ ${#files[@]} -eq 0 ]; then
            echo "::error::No text files in build/text. PDF extraction likely failed or wrote to another folder."
            exit 1
          fi

      # 3) Primær parser (din eksisterende) — må gerne give 0; vi falder tilbage nedenfor
      - name: Parse PFA PDFs → latest.json (primary)
        run: |
          set -euo pipefail
          python -m parser.main || true

      # 4) Fallback-parser: Robust NAV + dato ud af TXT, selv ved skiftende layout
      - name: Fallback parse (from TXT → data/latest.json)
        if: ${{ !hashFiles('data/latest.json') }}
        run: |
          set -euo pipefail
          python - << 'PYCODE'
          import re, json, pathlib
          from datetime import datetime

          TEXT_DIR = pathlib.Path("build/text")
          OUT_PATH = pathlib.Path("data/latest.json")
          OUT_PATH.parent.mkdir(parents=True, exist_ok=True)

          def to_float_dk(s: str):
            s = s.strip().replace(".", "").replace(",", ".")
            try:
              return float(s)
            except Exception:
              return None

          # Dato-mønstre (flere varianter)
          DATE_PATTERNS = [
              r"Indre\s*v[æa]rdi\s*dato[:\s]*([0-9]{2}-[0-9]{2}-[0-9]{4})",
              r"Indre\s*v[æa]rdi\s*dato[:\s]*([0-9]{4}-[0-9]{2}-[0-9]{2})",
              r"Indre\s*v[æa]rdi\s*dato[:\s]*([0-9]{2}/[0-9]{2}/[0-9]{4})",
              r"(?:NAV|Kurs)\s*dato[:\s]*([0-9]{2}-[0-9]{2}-[0-9]{4})",
              r"(?:NAV|Kurs)\s*dato[:\s]*([0-9]{4}-[0-9]{2}-[0-9]{2})",
              r"(?:NAV|Kurs)\s*dato[:\s]*([0-9]{2}/[0-9]{2}/[0-9]{4})",
          ]
          DATE_FMT_TRY = ["%d-%m-%Y", "%Y-%m-%d", "%d/%m/%Y"]

          RE_VALUTA = re.compile(r"Valuta\s+([A-Z]{3})", re.IGNORECASE)

          # - Direkte: "Indre værdi 125,16" (tillad lidt støj)
          RE_NAV_DIRECT = re.compile(
              r"Indre\s*v[æa]rdi(?:\s*[^0-9\n]{0,60}\s*)([0-9]{1,3}(?:\.[0-9]{3})*(?:,[0-9]+)?)",
              re.IGNORECASE,
          )
          # - Alle tal uden % (for at undgå afkast-procenter)
          RE_NUMBER_NO_PCT = re.compile(r"([0-9]{1,3}(?:\.[0-9]{3})*(?:,[0-9]+))(?!\s*%)")

          def norm_date(s: str):
            for fmt in DATE_FMT_TRY:
              try:
                return datetime.strptime(s, fmt).date().isoformat()
              except Exception:
                pass
            return s  # ukendt format → lad original stå

          funds = []
          logs = []

          for path in sorted(TEXT_DIR.glob("*.txt")):
            txt = path.read_text(encoding="utf-8", errors="ignore")
            low = txt.lower()

            # Name = første ikke-tomme linje
            name = next((ln.strip() for ln in txt.splitlines() if ln.strip()), "")

            # 1) Prøv direkte "Indre værdi <tal>"
            nav = None
            m_nav = RE_NAV_DIRECT.search(txt)
            if m_nav:
              nav = to_float_dk(m_nav.group(1))

            # 2) Dato (flere varianter)
            nav_date = None
            for pat in DATE_PATTERNS:
              m = re.search(pat, txt, flags=re.IGNORECASE)
              if m:
                nav_date = norm_date(m.group(1))
                break

            # 3) Hvis NAV stadig None → kig i Stamdata-blokken
            if nav is None:
              start = low.find("stamdata")
              if start != -1:
                # Heuristik: blok slutter ved næste 'Afkast' / 'Afkast ved en opsparing'
                ends = [i for i in [low.find("afkast ved en opsparing", start),
                                    low.find("afkast", start)] if i != -1]
                end = min(ends) if ends else None
                block = txt[start:end] if end else txt[start:]

                # Alle tal uden % i blokken
                cands = [(m.group(1), m.start()) for m in RE_NUMBER_NO_PCT.finditer(block)]
                if cands:
                  # Hvis 'Indre værdi' findes i blokken, vælg tal tættest på den tekst
                  idx_iv = block.lower().find("indre værdi")
                  if idx_iv != -1:
                    cands.sort(key=lambda t: abs(t[1] - idx_iv))
                    nav = to_float_dk(cands[0][0])
                  else:
                    nav = to_float_dk(cands[0][0])

            # 4) Valuta (valgfri)
            currency = None
            m_cur = RE_VALUTA.search(txt)
            if m_cur:
              currency = m_cur.group(1).upper()

            funds.append({
              "pfa_code": path.stem,    # fx PFA000002703
              "name": name,
              "currency": currency,
              "nav": nav,
              "nav_date": nav_date
            })

            # Log pr. fond i Actions-loggen
            logs.append(f"[PARSE] {path.stem}: NAV={nav} NAVDate={nav_date}")

          # Skriv output
          OUT_PATH.write_text(json.dumps({"funds": funds}, ensure_ascii=False, indent=2), encoding="utf-8")
          print(f"Wrote {OUT_PATH} with {len(funds)} entries")
          print("\n".join(logs))
          PYCODE

      # 5) Bekræft at latest.json findes og har indhold
      - name: Assert latest.json exists and not empty
        run: |
          set -euo pipefail
          test -s data/latest.json || (echo "::error::data/latest.json missing or empty" && exit 1)
          echo "== data/latest.json (first 120 lines) =="
          head -n 120 data/latest.json || true

      # 6) Udvidet diagnostik
      - name: Enhanced diagnostics (tree + sample content)
        run: |
          set -euo pipefail
          echo "== build/pdf =="; ls -la build/pdf || true
          echo "== build/text (should contain .txt) =="; ls -la build/text || true
          echo "== First TXT preview =="
          first_txt="$(ls build/text/*.txt 2>/dev/null | head -n1 || true)"
          echo "FIRST_TXT: $first_txt"
          if [ -n "${first_txt:-}" ] && [ -f "$first_txt" ]; then
            head -n 40 "$first_txt" || true
          fi
          echo "== data/latest.json (first 120 lines) =="
          head -n 120 data/latest.json || true

      # 7) Byg HTML (din opdaterede build_daily.py med f-strings)
      - name: Build daily HTML
        run: |
          set -euo pipefail
          python reporting/build_daily.py

      # 8) Upload artifacts
      - name: Upload daily artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily
          path: build/daily.html
          if-no-files-found: error

      - name: Upload parse-debug (text + pdf)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parse-debug
          path: |
            build/text/
            build/pdf/
          if-no-files-found: ignore

      - name: Upload data artifact (latest.json)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-latest-json
          path: data/latest.json
          if-no-files-found: warn
